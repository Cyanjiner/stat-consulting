---
title: "Latent class analysis"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r load in Client Data}
library(dplyr)
library(plyr)
library(poLCA)
library(plotly)
library(ggplot2)
mydata <- read.csv('ClientAllData.csv')[-1]
```

# Latent Class Analysis

#### 1. First, make sure all variables are factors and subset the data to include only LCA classification variables and covariates:

```{r subset data,eval=FALSE}
lca_subset<-subset(mydata, select=c(StudyClientId, age_group, Gender, Race, MaritalStatus, Religion, Aod1_class, Aod2_class, Disruption_class, LegalNonConform_class, LifeFunctionality_class, Suicide_class, Homicide_class, Trauma_class))
lca_subset$Gender[!(lca_subset$Gender %in% c("M","F"))]<- NA
lca_subset$Race[lca_subset$Race %in% c("Not on file","Undisclosed")] <- NA
lca_subset$MaritalStatus[lca_subset$MaritalStatus %in% c("","Not Specified")] <- NA
lca_subset$Religion[lca_subset$Religion %in% c('','Unknown')] <- NA
lca_subset <- lca_subset %>% tidyr::drop_na()
```

```{r recode VARS values to numbers, include=FALSE,eval=FALSE}
# recode response values to numbers starting at "1" (It's a poLCA thing)
lca_subset$age_group<-revalue(lca_subset$age_group, 
                              c("18-30"="1", 
                                "31-50"="2",
                                ">50"="3"))
lca_subset$Gender<-revalue(lca_subset$Gender, c("M"="1", "F"="2"))
lca_subset$Race<-revalue(lca_subset$Race, 
                         c("Caucasian or White"="1", 
                           "African American or Black"="2",
                           'American Indian or Alaskan Native'='3',
                           'Asian' = '4', 
                           'Native Hawaiian/Other Pacific Islander'='5',
                           'Multi-Racial'='6',
                           'Some other race' = '7'))
lca_subset$MaritalStatus<-revalue(lca_subset$MaritalStatus, 
                                  c("Single/Never Married"="1", 
                                    "Married"="2",
                                    "Divorced/Annulled"='3',
                                    'Civil Union'='4',
                                    'Legally separated'='5',
                                    'Widow/widower'='6',
                                    'Other'='7'))
lca_subset$Religion<-revalue(lca_subset$Religion, 
                             c("Catholic"="1", 
                               "Atheist"="2",
                               "Agnostic"="3",
                               "Protestant"="4",
                               "Christian"="5",
                               "Islamic"="6",
                               "Baptist"="7",
                               "Pentecostal"="8",
                               "Buddhist"="9",
                               "Jewish"="10",
                               "Orthodox Christian"="11",
                               "Mormon"="12",
                               "None"="13",
                               "Other"="14"))
lca_subset$Aod1_class<-revalue(lca_subset$Aod1_class, 
                               c("low"="1", "medium"="2",'high'='3'))
lca_subset$Aod2_class<-revalue(lca_subset$Aod2_class, 
                               c("low"="1", "medium"="2",'high'='3'))
lca_subset$Disruption_class<-revalue(lca_subset$Disruption_class, 
                                     c("low"="1", "medium"="2",'high'='3'))
lca_subset$LegalNonConform_class<-revalue(lca_subset$LegalNonConform_class, c("low"="1", "medium"="2",'high'='3'))
lca_subset$LifeFunctionality_class<-revalue(lca_subset$LifeFunctionality_class, c(c("low"="1", "medium"="2",'high'='3')))
lca_subset$Suicide_class<-revalue(lca_subset$Suicide_class,
                                  c("low"="1", "medium"="2",'high'='3'))
lca_subset$Homicide_class<-revalue(lca_subset$Homicide_class, 
                                   c("low"="1", "medium"="2",'high'='3'))
lca_subset$Trauma_class<-revalue(lca_subset$Trauma_class, c("no/unknown"="2", "yes"="1"))
```

```{r factorize all VARS, eval=FALSE}
# make sure all variables are factors
lca_subset[-1] <- lapply(lca_subset[-1], factor)
```

#### 2. Second, define the LCA formula.

-   Variables in parentheses are the latent class classification variables.

-   Variables outside of the parentheses are covariates (not included in the LCA).

-   Finally, run the LCA specifying a range of classes

-   LCA: Classification VARS: ASUS / Risk/ Trauma

-   covariates: demographics (no location)

-   chisq+post-hoc: latent class vs. Outcome: Incident Score --\> binary

```{r define covariates and variables, eval=FALSE}
f <- cbind(Aod1_class,Aod2_class,Disruption_class,LegalNonConform_class,LifeFunctionality_class,Suicide_class,Homicide_class,Trauma_class)~age_group+Race+MaritalStatus+Religion
```

```{r check missing values, eval=FALSE}
sapply(lca_subset, function(x) sum(is.na(x)))
```

```{r run poLCA analysis, eval=FALSE}
# latent class analysis specifying 1-3 classes
lCA1 <- poLCA(f,lca_subset, nclass=1,nrep=15) 
lCA2 <- poLCA(f,lca_subset, nclass=2,nrep=15, graphs = T)
lCA3 <- poLCA(f,lca_subset, nclass=3,nrep=15, graphs = T)

```

```{r calculate entropy, eval=FALSE}
# Calculate entropy (3-class mode)l- values closer to 1.0 indicate greater separation of the classes.
entropy<-function (p) sum(-p*log(p))
error_prior <- entropy(lCA3$P) # Class proportions
error_post <- mean(apply(lCA3$posterior, 1, entropy))
LCA3_entropy <- (error_prior - error_post) / error_prior
LCA3_entropy
```

```{r predict class membership, eval=FALSE}
#predicted class membership is in:
lCA3$predclass[1:30]
#add variable to data set with all variables so it can be used as predictor variable:
lca_subset$class <- lCA3$predclass
```

# Visualizations

## Demographics

```{r merge class back to orginal data, eval=FALSE}
data <- mydata %>% 
  inner_join(lca_subset[,c(1,15)], by = "StudyClientId")
write.csv(data,"client_class.csv")
```

```{r, include=FALSE}
data <- read.csv("client_class.csv")[-1]
```

```{r class versus age, echo=FALSE}
data <- mutate(data, class = as.factor(class))

age_plot <- ggplot(data, aes(x=CurrentAge, color=class, fill=class))+
  geom_density(alpha=0.4)+
  theme_minimal()+
  xlab("Current Age")+
  ylab("")+
  ggtitle("Client class by Age")
ggplotly(age_plot)
```

```{r class versus gender,echo=FALSE}
gender_plot <- data %>% 
  ggplot(aes(x=Gender, fill=Gender))+
  geom_bar()+
  facet_wrap(~class, labeller = label_both, scales="free")+
  ggtitle("Client class by Gender")
ggplotly(gender_plot)
```

```{r class versus race, echo=FALSE}
race_plot <- 
  ggplot(data,aes(x=Race, fill=Race))+
  geom_bar()+
  facet_grid(rows=vars(class), labeller = label_both, scales="free")+
  ggtitle("Client class by Race")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank() 
        )
ggplotly(race_plot)
```

```{r class versus religion, echo=FALSE}
religion_plot <- 
  ggplot(data,aes(x=Religion, fill=Religion))+
  geom_bar()+
  facet_grid(rows=vars(class), labeller = label_both, scales="free")+
  ggtitle("Client class by Religion")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank() 
        )
ggplotly(religion_plot)
```

```{r class versus marital status, echo=FALSE}
marital_plot <- 
  ggplot(data,aes(x=MaritalStatus, fill=MaritalStatus))+
  geom_bar()+
  facet_grid(rows=vars(class), labeller = label_both, scales="free")+
  ggtitle("Client class by Marital Status")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank() 
        )
ggplotly(marital_plot)
```

## ASUS

```{r class vs aod1, echo=FALSE}
aod1_plot <- ggplot(data, aes(x=AodInvolvement, color=class, fill=class))+
  geom_density(alpha=0.4)+
  theme_minimal()+
  xlab("Lifetime AOD Involvement Score")+
  ylab("")+
  ggtitle("Distribution of AOD Lifetime Involvement by Client Class")
ggplotly(aod1_plot)
```

```{r aod last 6 months, echo=FALSE}
aod2_plot <- data %>% 
  mutate(Aod2_class = factor(Aod2_class, levels=c("low","medium","high"))) %>% 
  ggplot(aes(x=Aod2_class,fill=class))+
  geom_bar(alpha=0.7)+
  facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("AOD Involvement Level Last Six Months")+
  ylab("")+
  ggtitle("AOD Involvement Level Last Six Months")
ggplotly(aod2_plot)
```

```{r legal non conform, echo=FALSE}
legal_plot <- data %>% 
  mutate(LegalNonConform_class = factor(LegalNonConform_class, levels=c("low","medium","high"))) %>% 
  ggplot(aes(x=LegalNonConform_class,fill=class))+
  geom_bar(alpha=0.7)+
  facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("Legal Non Conforming Problems Last Six Months")+
  ylab("")+
  ggtitle("Legal Non Conforming Problems")
ggplotly(legal_plot)
```

```{r class vs. disruption, echo=FALSE}
dis_plot <- data %>% 
  mutate(Disruption_class = factor(Disruption_class, levels=c("low","medium","high"))) %>% 
  ggplot(aes(x=Disruption_class,fill=class))+
  geom_bar(alpha=0.7)+
  facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("Disruption Score")+
  ylab("")+
  ggtitle("Distribution of Disruption by Client Class")
ggplotly(dis_plot)
```

```{r life functionality vs. class, echo=FALSE}
func_plot <- 
  ggplot(data, aes(x=GlobalAodPsychosocialDistruptionAndProblems,fill=class,color=class))+
  geom_density(alpha=0.5)+
 # facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("Life Functionality Problems")+
  ylab("")+
  ggtitle("Life Functionality Problems by Client Class")
ggplotly(func_plot)
```

## RISK

```{r suicide risk, echo=FALSE}
suicide_plot <- data %>% 
  filter(SuicideRisk_Total != 0) %>% 
  ggplot(aes(x=SuicideRisk_Total,fill=class))+
  geom_bar(alpha=0.7)+
  facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("Suicide Risks Level")+
  ylab("")+
  ggtitle("Suicide Risk Levels by Client Class")
ggplotly(suicide_plot)
```

```{r homicide risk, echo=FALSE}
homicide_plot <- data %>% 
  filter(HomicideRisk_Total != 0) %>% 
  ggplot(aes(x=HomicideRisk_Total,fill=class))+
  geom_bar(alpha=0.7)+
  facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("Homicide Risks Level")+
  ylab("")+
  ggtitle("Homicide Risk Levels by Client Class")
ggplotly(homicide_plot)
```

## Trauma

```{r trauma history, echo=FALSE}
trauma_plot <- data %>% 
  ggplot(aes(x=Trauma_class, fill=Trauma_class))+
  geom_bar(alpha=0.8)+
  facet_wrap(~class, labeller = label_both, scales="free")+
  ylab("Trauma History")+
  ggtitle("Client Class vs. Trauma History")
ggplotly(trauma_plot)
```

## Incidents

```{r incidents, echo=FALSE}
incident_plot <- data %>% 
  filter(IncidentScore != 0) %>% 
  ggplot(aes(x=IncidentScore,fill=class))+
  geom_density(alpha=0.7)+
  facet_grid(rows=vars(class),labeller = label_both,scales="free")+
  theme_minimal()+
  xlab("Incident Scores")+
  ylab("")+
  ggtitle("Incident Scores by client class")
ggplotly(incident_plot)
```

# Client Class Profiles

## Client Class 1

```{r}
data %>% group_by(class) %>% 
  summarise(n=n())
```

```{r age}
data %>% group_by(class) %>% 
  summarise(min=min(CurrentAge),
            median=median(CurrentAge),
            mean=mean(CurrentAge),
            max=max(CurrentAge))
```

```{r race}
data %>% filter(class==1) %>% 
  group_by(Race) %>% 
  summarise(counts=n(),
            percent=round(counts/nrow(data[data$class==1,]),2)) %>% 
  arrange(desc(counts))
```

```{r religion}
data %>% filter(class==1) %>% 
  group_by(Religion) %>% 
  summarise(counts=n(),
            percent=round(counts/nrow(data[data$class==1,]),3)) %>% 
  arrange(desc(counts))
```

# Chi-square Test (Incident_class vs. Class membership)

```{r chi-square}
data <- data %>% 
  mutate(Incident_class = ifelse(IncidentScore == 1,"Yes","No"),
         Client_class = as.factor(class))

chi <- chisq.test(data$Incident_class, data$Client_class)
chi
```

```{r observed cell counts}
chi$observed
```

```{r col perc}
prop.table(chi$observed, 2)
```

```{r row perc}
prop.table(chi$observed, 1)
```

```{r post-hoc}
source('https://raw.githubusercontent.com/PassionDrivenStatistics/R/master/ChiSquarePostHoc.R')

chisq.post.hoc(chi$observed, popsInRows=FALSE, control="bonferroni")
```

```{r chi square location}
chi2 <- chisq.test(data$City, data$Client_class)
chi2
```

```{r location prop table}
prop.table(chi2$observed, 2)
```

```{r location prop table2}
prop.table(chi2$observed, 1)
```

```{r chi2 table}
chi2$observed
```


### Client class profiles
```{r rescale data}
library(tidyr)
# get rescaled data matrix of numeric variables using min-max difference normalization
maxmin <- function(x){
  x <- (x-min(x))/(max(x)-min(x))
}
data_mat <- data %>% 
  select(Client_class,CurrentAge, SuicideRisk_Total, HomicideRisk_Total, IncidentScore, CriminalHistory, TraumaHistory, AodInvolvement, Disruption, AodLastSixMonths, LegalNonConformingLastSixMonths,GlobalAodPsychosocialDistruptionAndProblems) %>% 
  mutate(Client_class=as.numeric(as.character(Client_class)))
data_mat[is.na(data_mat$TraumaHistory),]$TraumaHistory = 0
data_mat[is.na(data_mat$CriminalHistory),]$CriminalHistory = 0

data_scaled <- data_mat %>% 
  drop_na() %>% 
  sapply(maxmin) %>% 
  as.data.frame() %>% 
  mutate(Client_class = data_mat$Client_class) %>% 
  group_by(Client_class) %>% 
  summarise(Age = mean(CurrentAge),
            SuicideRisk_Total=mean(SuicideRisk_Total),
            HomicideRisk_Total=mean(HomicideRisk_Total),
            TraumaHistory = mean(TraumaHistory),
            CriminalHistory = mean(CriminalHistory),
            AodInvolvement = mean(AodInvolvement),
            Disruption = mean(Disruption),
            LifeFunctionProblem = mean(GlobalAodPsychosocialDistruptionAndProblems),
            AodLastSixMonths = mean(AodLastSixMonths),
            LegalNonConform = mean(LegalNonConformingLastSixMonths))
```

```{r cluster 1 profie}
library(fmsb)
all_cluster1 <- data_scaled %>% 
  filter(Client_class==1) 
# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
all_cluster1 <- rbind(rep(0.75,11) , rep(0,11) , all_cluster1)
radarchart(all_cluster1[-1],axistype=1,
           # custom polygon
           pcol = rgb(0.2,0.5,0.5,0.9), pfcol =rgb(0.2,0.5,0.5,0.5), plwd=4,
           # custom grid
           cglcol = "grey", cglty = 1, axislabcol = "grey", caxislabels = c(0,0.15,0.25,0.5,0.75), cglwd=0.8,
           # custom labels
           vlcex = 0.7, # font size for labels
           vlabels = c("Age","Suicide\nRisk","Homicide\nRisk"," Trauma\nHistory","Criminal\nHistory","Aod\nInvolvement","Disruption","Life\nFunctioning\nProblems","Aod Last\nSix Months","Legal Non-Conforming\nProblems"),
           calcex = 0.8, # font size of center axis labels
           title="Cluster 1 Profile")
```

```{r cluster 2 profie}
all_cluster2 <- data_scaled %>% 
  filter(Client_class==2) 
# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
all_cluster2 <- rbind(rep(0.75,11) , rep(0,11) , all_cluster2)
radarchart(all_cluster2[-1],axistype=1,
           # custom polygon
           pcol = 4, pfcol =rgb(0, 0.4, 1, 0.25), plwd=4,
           # custom grid
           cglcol = "grey", cglty = 1, axislabcol = "grey", caxislabels =  c(0,0.15,0.25,0.5,0.75), cglwd=0.8,
           # custom labels
           vlcex = 0.7, # font size for labels
           vlabels = c("Age","Suicide\nRisk","Homicide\nRisk"," Trauma\nHistory","Criminal\nHistory","Aod\nInvolvement","Disruption","Life\nFunctioning\nProblems","Aod Last\nSix Months","Legal Non-Conforming\nProblems"),
           calcex = 0.8, # font size of center axis labels
           title="Cluster 2 Profile")
```

```{r cluster 3 profie}
all_cluster3 <- data_scaled %>% 
  filter(Client_class==3) 
# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
all_cluster3 <- rbind(rep(0.75,11) , rep(0,11) , all_cluster3)
radarchart(all_cluster3[-1],axistype=1,
           # custom polygon
           pcol = rgb(1, 0.4, 0.6, 0.9), pfcol =rgb(1, 0.4, 0.6, 0.25), plwd=4,
           # custom grid
           cglcol = "grey", cglty = 1, axislabcol = "grey", caxislabels =  c(0,0.15,0.25,0.5,0.75), cglwd=0.8,
           # custom labels
           vlcex = 0.7, # font size for labels
           vlabels = c("Age","Suicide\nRisk","Homicide\nRisk"," Trauma\nHistory","Criminal\nHistory","Aod\nInvolvement","Disruption","Life\nFunctioning\nProblems","Aod Last\nSix Months","Legal Non-Conforming\nProblems"),
           calcex = 0.8, # font size of center axis labels
           title="Cluster 3 Profile")
```

```{r table, include=FALSE}
table <- 
  data_mat %>% 
  group_by(Client_class) %>% 
  summarise(`Current Age` = mean(CurrentAge),
            `Suicide Risk Level`=mean(SuicideRisk_Total),
            `Homicide Risk Level`=mean(HomicideRisk_Total),
            `Criminal History` = mean(CriminalHistory),
            `Aod Involvement` = mean(AodInvolvement),
            `Disruption` = mean(Disruption),
            `Life Functioning Problems` = mean(GlobalAodPsychosocialDistruptionAndProblems),
            `Aod Last Six Months` = mean(AodLastSixMonths),
            `Legal Non-Conforming Problems` = mean(LegalNonConformingLastSixMonths))  %>% 
  t() %>% 
  round(digits = 2) %>% 
  as.data.frame() 
table <- table[-1,]
colnames(table) <- c("Cluster 1", "Cluster 2", "Cluster 3")
table2 <- 
      rbind(`Number of Clients`=c(905,467,442),
      table, 
      `Proportion with Trauma History` = c('33%','28%','44%'))
```

```{r draw table}
library(kableExtra)
table2[2,3] <- cell_spec(table2[2,3], color = "white", background = "red",bold = T)
table2[3,3] <- cell_spec(table2[3,3], color = "white", background = "red",bold = T)
table2[3,2] <- cell_spec(table2[3,2], color = "white", background = "green",bold = T)
table2[4,2] <- cell_spec(table2[4,2], color = "white", background = "green",bold = T)
table2[4,3] <- cell_spec(table2[4,3], color = "white", background = "red",bold = T)
table2[5,1] <- cell_spec(table2[5,1], color = "white", background = "red",bold = T)
table2[6,3] <- cell_spec(table2[6,3], color = "white", background = "red",bold = T)
table2[6,2] <- cell_spec(table2[6,2], color = "white", background = "green",bold = T)
table2[7,3] <- cell_spec(table2[7,3], color = "white", background = "red",bold = T)
table2[7,2] <- cell_spec(table2[7,2], color = "white", background = "green",bold = T)
table2[8,3] <- cell_spec(table2[8,3], color = "white", background = "red",bold = T)
table2[8,2] <- cell_spec(table2[8,2], color = "white", background = "green",bold = T)
table2[9,3] <- cell_spec(table2[9,3], color = "white", background = "red",bold = T)
table2[9,2] <- cell_spec(table2[9,2], color = "white", background = "green",bold = T)
table2[10,3] <- cell_spec(table2[10,3], color = "white", background = "red",bold = T)
table2[10,2] <- cell_spec(table2[10,2], color = "white", background = "green",bold = T)
table2[11,3] <- cell_spec(table2[11,3], color = "white", background = "red",bold = T)
table2[11,2] <- cell_spec(table2[11,2], color = "white", background = "green",bold = T)
table2 %>% 
  kbl(escape = F, booktabs = T) %>% 
  kable_styling(bootstrap_options = "striped", position = "left")
```


```{r summary, echo=FALSE}
data[is.na(data$CriminalHistory),]$CriminalHistory = 0
data3 <- data %>% 
  select(Client_class,CurrentAge, Gender, Race, MaritalStatus, Religion, City, SuicideRisk_Total, HomicideRisk_Total, IncidentScore, CriminalHistory, TraumaHistory, AodInvolvement, Disruption, AodLastSixMonths, LegalNonConformingLastSixMonths,GlobalAodPsychosocialDistruptionAndProblems) %>% 
   mutate(TraumaHistory = as.factor(case_when(is.na(TraumaHistory)~0,
                                    TraumaHistory == 1~1,
                                    TraumaHistory == 0~0)),
          Gender = as.factor(Gender),
          Race=as.factor(Race),
          MaritalStatus=as.factor(MaritalStatus),
          Religion=as.factor(Religion),
          `Discharged City`=as.factor(City)) 
cluster1_demo <- data3 %>% 
  filter(Client_class == 1) %>% 
  select(Gender, Race, MaritalStatus, Religion, `Discharged City`) %>% 
  do(`Demographics Summary`=summary(.))
cluster2_demo <- data3 %>% 
  filter(Client_class == 2) %>% 
  select(Gender, Race, MaritalStatus, Religion, `Discharged City`) %>% 
  do(`Demographics Summary`=summary(.))
cluster3_demo <- data3 %>% 
  filter(Client_class == 3) %>% 
  select(Gender, Race, MaritalStatus, Religion, `Discharged City`) %>% 
  do(`Demographics Summary`=summary(.))
```

```{r display summary}
cluster1_demo$`Demographics Summary`
cluster2_demo$`Demographics Summary`
cluster3_demo$`Demographics Summary`
```

